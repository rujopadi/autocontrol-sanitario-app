<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Monitoreo - Autocontrol Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e1e5e9;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }

        .metric-value {
            font-weight: 600;
            font-size: 1rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-healthy { background-color: #27ae60; }
        .status-warning { background-color: #f39c12; }
        .status-critical { background-color: #e74c3c; }
        .status-unknown { background-color: #95a5a6; }

        .alert {
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .alert-critical {
            background-color: #fdf2f2;
            border: 1px solid #fca5a5;
            color: #991b1b;
        }

        .alert-high {
            background-color: #fef3cd;
            border: 1px solid #fbbf24;
            color: #92400e;
        }

        .alert-medium {
            background-color: #dbeafe;
            border: 1px solid #60a5fa;
            color: #1e40af;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: transform 0.2s;
        }

        .refresh-btn:hover {
            transform: translateY(-1px);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            background-color: #fef2f2;
            border: 1px solid #fca5a5;
            color: #991b1b;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .timestamp {
            color: #666;
            font-size: 0.8rem;
            text-align: right;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔍 Sistema de Monitoreo - Autocontrol Pro</h1>
    </div>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2>Dashboard de Monitoreo</h2>
            <button class="refresh-btn" onclick="refreshDashboard()">🔄 Actualizar</button>
        </div>

        <div id="loading" class="loading">
            <p>Cargando datos de monitoreo...</p>
        </div>

        <div id="error" class="error" style="display: none;">
            <p>Error al cargar los datos de monitoreo. Por favor, inténtalo de nuevo.</p>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="dashboard-grid">
                <!-- System Health Card -->
                <div class="card">
                    <h3>🏥 Estado del Sistema</h3>
                    <div id="system-health">
                        <div class="metric">
                            <span class="metric-label">Estado General</span>
                            <span class="metric-value" id="health-status">
                                <span class="status-indicator status-unknown"></span>
                                Desconocido
                            </span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Última Verificación</span>
                            <span class="metric-value" id="health-timestamp">-</span>
                        </div>
                    </div>
                </div>

                <!-- System Metrics Card -->
                <div class="card">
                    <h3>📊 Métricas del Sistema</h3>
                    <div id="system-metrics">
                        <div class="metric">
                            <span class="metric-label">Uso de CPU</span>
                            <span class="metric-value" id="cpu-usage">-%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Uso de Memoria</span>
                            <span class="metric-value" id="memory-usage">-%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Tiempo de Respuesta DB</span>
                            <span class="metric-value" id="db-response">-ms</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Tasa de Errores</span>
                            <span class="metric-value" id="error-rate">-%</span>
                        </div>
                    </div>
                </div>

                <!-- Business Metrics Card -->
                <div class="card">
                    <h3>💼 Métricas de Negocio</h3>
                    <div id="business-metrics">
                        <div class="metric">
                            <span class="metric-label">Usuarios Activos</span>
                            <span class="metric-value" id="active-users">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Organizaciones Activas</span>
                            <span class="metric-value" id="active-orgs">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Registros Totales</span>
                            <span class="metric-value" id="total-records">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Registros Hoy</span>
                            <span class="metric-value" id="records-today">-</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Alerts Card -->
                <div class="card">
                    <h3>🚨 Alertas Recientes</h3>
                    <div id="recent-alerts">
                        <p style="color: #666; text-align: center; padding: 1rem;">No hay alertas recientes</p>
                    </div>
                </div>
            </div>

            <div class="timestamp" id="last-updated">
                Última actualización: -
            </div>
        </div>
    </div>

    <script>
        let authToken = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Try to get auth token from localStorage or prompt user
            authToken = localStorage.getItem('authToken');
            if (!authToken) {
                authToken = prompt('Por favor, ingresa tu token de autenticación:');
                if (authToken) {
                    localStorage.setItem('authToken', authToken);
                }
            }

            if (authToken) {
                loadDashboard();
                // Auto-refresh every 30 seconds
                setInterval(loadDashboard, 30000);
            } else {
                showError('Token de autenticación requerido');
            }
        });

        async function loadDashboard() {
            try {
                showLoading();
                
                const [healthResponse, dashboardResponse, alertsResponse] = await Promise.all([
                    fetch('/api/monitoring/health', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch('/api/monitoring/dashboard', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch('/api/monitoring/alerts?limit=5', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);

                if (!healthResponse.ok || !dashboardResponse.ok || !alertsResponse.ok) {
                    throw new Error('Error al cargar datos del servidor');
                }

                const healthData = await healthResponse.json();
                const dashboardData = await dashboardResponse.json();
                const alertsData = await alertsResponse.json();

                updateHealthStatus(healthData.data);
                updateSystemMetrics(dashboardData.data);
                updateAlerts(alertsData.data.alerts);

                showDashboard();
                updateTimestamp();

            } catch (error) {
                console.error('Dashboard load error:', error);
                showError('Error al cargar el dashboard: ' + error.message);
            }
        }

        function updateHealthStatus(healthData) {
            const statusElement = document.getElementById('health-status');
            const timestampElement = document.getElementById('health-timestamp');

            const statusMap = {
                'healthy': { text: 'Saludable', class: 'status-healthy' },
                'warning': { text: 'Advertencia', class: 'status-warning' },
                'critical': { text: 'Crítico', class: 'status-critical' },
                'unknown': { text: 'Desconocido', class: 'status-unknown' }
            };

            const status = statusMap[healthData.status] || statusMap.unknown;
            
            statusElement.innerHTML = `
                <span class="status-indicator ${status.class}"></span>
                ${status.text}
            `;

            timestampElement.textContent = new Date(healthData.timestamp).toLocaleString('es-ES');
        }

        function updateSystemMetrics(dashboardData) {
            const recentMetrics = dashboardData.recentMetrics;
            if (recentMetrics && recentMetrics.length > 0) {
                const latest = recentMetrics[recentMetrics.length - 1];
                
                document.getElementById('cpu-usage').textContent = 
                    latest.metrics.cpu?.usage ? `${latest.metrics.cpu.usage.toFixed(1)}%` : 'N/A';
                
                document.getElementById('memory-usage').textContent = 
                    latest.metrics.memory?.usage ? `${latest.metrics.memory.usage.toFixed(1)}%` : 'N/A';
                
                document.getElementById('db-response').textContent = 
                    latest.metrics.database?.responseTime ? `${latest.metrics.database.responseTime}ms` : 'N/A';
                
                document.getElementById('error-rate').textContent = 
                    latest.metrics.api?.errorRate ? `${latest.metrics.api.errorRate.toFixed(2)}%` : 'N/A';

                // Business metrics
                if (latest.metrics.business) {
                    document.getElementById('active-users').textContent = 
                        latest.metrics.business.activeUsers || '0';
                    document.getElementById('active-orgs').textContent = 
                        latest.metrics.business.activeOrganizations || '0';
                    document.getElementById('total-records').textContent = 
                        latest.metrics.business.totalRecords || '0';
                    document.getElementById('records-today').textContent = 
                        latest.metrics.business.recordsCreatedToday || '0';
                }
            }
        }

        function updateAlerts(alerts) {
            const alertsContainer = document.getElementById('recent-alerts');
            
            if (!alerts || alerts.length === 0) {
                alertsContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 1rem;">No hay alertas recientes</p>';
                return;
            }

            const alertsHtml = alerts.map(alert => {
                const alertClass = `alert-${alert.severity}`;
                const timestamp = new Date(alert.timestamp).toLocaleString('es-ES');
                
                return `
                    <div class="alert ${alertClass}">
                        <strong>${alert.type.toUpperCase()}:</strong> ${alert.message}
                        <br><small>${timestamp}</small>
                    </div>
                `;
            }).join('');

            alertsContainer.innerHTML = alertsHtml;
        }

        function refreshDashboard() {
            loadDashboard();
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = `<p>${message}</p>`;
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        function updateTimestamp() {
            document.getElementById('last-updated').textContent = 
                `Última actualización: ${new Date().toLocaleString('es-ES')}`;
        }
    </script>
</body>
</html>